<!DOCTYPE html>
<html lang="en">
    <head>
        {meta}
        <link rel="stylesheet" href="/style.css" >
        <title>Search - OculusDB</title>
        <meta name="title" content="Search - OculusDB">
        <meta name="description" content="Search OculusDB">
    </head>
    <body>
        <noscript>This page relies on javascript. Please enable javascript on your browser</noscript>
        <div class="content">
            <div class="navBarElement">
                <input type="text" placeholder="Query" id="query2">
                <input type="button" onclick="Search('query2')" value="Search">
            </div>
            <div class="checkboxGrid" id="groupCheckboxes">
                
            </div>
            <div>
                <div class="info">
                    <div class="flex outside">
                        <div class="flex header" onclick="RevealDescription('advancedSearch')">
                            <div style="padding: 15px; font-weight: bold; color: var(--highlightedColor);" id="advancedSearch_trigger" class="anim noselect">&gt;</div>
                            <div stlye="font-size: 1em;">advanced search</div>
                        </div>
                    </div>

                    <div class="hidden" id="advancedSearch">
                        <div class="checkboxGrid" id="headsetCheckboxes">

                        </div>
                    </div>
                </div>
            </div>
            
            <h1>Results</h1>
            
            <div class="SearchResults" id="searchResults">

            </div>
            <div>
                Are we missing an app? Enter a valid app id
                <br>
                or url and we will add it to the database.
                <br>
                <input type="text" placeholder="App id or URL" id="addApp">
                <input type="button" value="Submit" onmousedown="MouseDown(event)" onmouseup="if(MouseUp(event)) AddApp()">
                <div class="textbox" id="reportmissingbox"></div>
            </div>
        </div>
        <script src="/script.js"></script>
        <script>
            var headsetCheckboxesHtml = ``
            var options = {}    
            for(const headset of headsets) {
                headsetCheckboxesHtml += `
                <label class="checkmarkContainer">
                    <div>${headset.displayName}</div>
                    <input type='checkbox' id="${headset.codename}_checkbox" onclick='UpdateHeadset(true)'>
                    <span class="checkmark"></span>
                </label>`
                options[`${headset.codename}_checkbox`] = [headset.codename]
            }
            var groupCheckboxesHtml = ``
            var groupOptions = {}
            for(const group of GetHeadsetGroups()) {
                groupCheckboxesHtml += `
            <label class="checkmarkContainer">
                <div>${group}</div>
                <input type='checkbox' id="${group}_checkbox" onclick='UpdateGroup("${group}", this.checked)'>
                <span class="checkmark"></span>
            </label>`
                groupOptions[`${group}_checkbox`] = [group]
            }
            document.getElementById("groupCheckboxes").innerHTML = groupCheckboxesHtml
            document.getElementById("headsetCheckboxes").innerHTML = headsetCheckboxesHtml
            
            function UpdateHeadset() {
                useGroups = false
                Update(true)
            }
            
            function UpdateGroup(group, checked) {
                useGroups = true
                for(const headset of GetHeadsetsOfGroup(group)) {
                    console.log(headset)
                    document.getElementById(`${headset.codename}_checkbox`).checked = checked
                }
                Update(true)
            }
            
            function UpdateGroupCheckboxesChecked() {
                for(const group of GetHeadsetGroups()) {
                    var allChecked = true
                    for(const headset of GetHeadsetsOfGroup(group)) {
                        if(!document.getElementById(`${headset.codename}_checkbox`).checked) {
                            allChecked = false
                            break
                        }
                    }
                    document.getElementById(`${group}_checkbox`).checked = allChecked
                }
            }

            var query = params.get("query")

            document.getElementById("query2").onkeydown = e => {
                if(e.code == "Enter") {
                    Search("query2")
                }
            }

            function AddApp() {
                var appId = document.getElementById("addApp").value
                TextBoxText("reportmissingbox", "Waiting for response")
                fetch(`/api/v1/reportmissing/${appId}`).then(res => {
                    res.text().then(text => {
                        if(res.status == 200) {
                            TextBoxGood("reportmissingbox", text)
                        } else if (res.status == 400) {
                            TextBoxError("reportmissingbox", text)
                        } else {
                            TextBoxError("reportmissingbox", "An unknown error occurred")
                        }
                    })
                })
            }

            

            SetCheckboxesBasedOnValue(options, params.get("headsets"))
            SetCheckboxesBasedOnValue(groupOptions, localStorage.isQAVS ? "Quest" : params.get("groups"))
            const SearchResults = document.getElementById("searchResults")

            var useGroups = true
            DoSearch()
            function DoSearch() {
                params.set("headsets", GetValuesOFCheckboxes(options))
                params.set("groups", GetValuesOFCheckboxes(groupOptions))
                document.getElementById("query").value = query
                document.getElementById("query2").value = query
                SearchResults.innerHTML = loader
                fetch("/api/v1/search/" + encodeURIComponent(query) + (useGroups ? `?groups=${params.get("groups")}` : `?headsets=${params.get("headsets")}`)).then(res => {
                    if(res.status != 200) {
                        res.text().then(text => {
                            PopUp(text)
                        })
                    } else {
                        res.json().then(res => {
                            var results = ""
                            res.forEach(x => {
                                results += FormatApplication(x, x.id)
                            })
                            if(results == "") {
                                results = noResult
                            }
                            SearchResults.innerHTML = results
                        })
                    }
                })
            }
            

            function Update(refresh = true) {
                params.set("groups", GetValuesOFCheckboxes(groupOptions))
                params.set("headsets", GetValuesOFCheckboxes(options))
                if(refresh) DoSearch()
                UpdateGroupCheckboxesChecked()
            }
        </script>
    </body>
</html>
